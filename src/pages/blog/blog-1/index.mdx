---
title: ArtÄ±k Python'da `elif` yazmak zorunda deÄŸilsiniz!
date: 2021-11-26
tags:
  - Python
  - CPython
  - Grammar
layout: "@layouts/BlogLayout.astro"
---

Twitterda gezinirken ÅŸÃ¶yle bir ÅŸey gÃ¶rdÃ¼m.

<blockquote class="twitter-tweet">
  ![Twitter Image](./tw_image.jpg)
  <p lang="tr" dir="ltr">
    Python yÃ¼zÃ¼nden dÃ¼nya bi data engineer kaybetti{" "}
    <a href="https://t.co/t1W8392Nrz">pic.twitter.com/t1W8392Nrz</a>
  </p>
  &mdash; IlterğŸ‡©ğŸ‡ª (@koseilteer){" "}
  <a href="https://twitter.com/koseilteer/status/1461979376199819266?ref_src=twsrc%5Etfw">
    November 20, 2021
  </a>
</blockquote>
<script
  async
  src="https://platform.twitter.com/widgets.js"
  charset="utf-8"
></script>

[Ä°lgili Tweet](https://twitter.com/koseilteer/status/1461979376199819266)

InsanlarÄ±n bir keyword yÃ¼zÃ¼nden Pythonu bÄ±rakmasÄ±na gÃ¶nlÃ¼m razÄ± olmadÄ± (!)
Bu yÃ¼zden bu `elif` keywordunu Python da `elseif` ile deÄŸiÅŸmeye karar verdim.

## Neden?

Makalenin amacÄ± troll olsa da Python'u kaynak kodu Ã¼zerinden derleyip iÃ§eride ne dÃ¶ndÃ¼ÄŸÃ¼ne bakmak, bu build
aÅŸamalarÄ±nÄ±n ne olduÄŸunu gÃ¶rmek yapmak istediÄŸim bir ÅŸeydi. Bir frontend dev olarak bu iÅŸler nasÄ±l oluyor bakmak istedim.

## CPython'Ä± Derlemek

Åimdi ÅŸunu belirtmekte fayda var, terminalinize gelip `python` yazdÄ±ÄŸÄ±nÄ±zda Ã§alÄ±ÅŸan ÅŸey %90 ihtimalle CPython. Peki ne bu CPython?
En kÄ±sa tanÄ±mÄ± ile, Pythonun bir implementasyonu. ÅÃ¶yle ki Python interpreteri de Python kodlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±ran bir program. CPython ise
bu programÄ±n C ile yazÄ±lmÄ±ÅŸ versiyonu. Pek Ã§ok version yazÄ±lmÄ±ÅŸ tabii ki ama en Ã§ok kullanÄ±lan bu version. CPythonun kaynak kodlarÄ±
[burada](https://github.com/python/cpython) bulunuyor. Buradan kendinize bir fork Ã§akÄ±p o forku bilgisayarÄ±nÄ±za klonlayÄ±n. Ben kendi adÄ±ma
klonlamÄ±ÅŸtÄ±m.

```bash
git clone https://github.com/bufgix/cpython
cd cpython
```

Mac bir cihaz kullandÄ±ÄŸÄ±m iÃ§in yapmam gereken ÅŸu

```bash
brew install openssl xz gdbm
```

sonrasÄ±nda `configure` scriptini Ã§alÄ±ÅŸtÄ±ralÄ±m

```bash
./configure --with-pydebug --with-openssl=$(brew --prefix openssl)
```

daha sonra build almaya geÃ§ebiliriz.

```bash title="build"
make -s -j2
```

`-j2` flagÄ± `make` in aynÄ± anda 2 iÅŸi yapmabilmesini saÄŸlar. EÄŸer 4 Ã§ekirdeÄŸiniz varsa `-j4` diyebilirsiniz.
Bu noktadan itibaren bilgisayarÄ±nÄ±zÄ±n fan seslerini ve `tkinter` gibi paketlerinden Ã§Ä±kan hatalarÄ± gÃ¶rmezden gelebilirsiniz.

Ä°ÅŸlem bittiÄŸinde tertemiz Python 3.11 binary si Ã§Ä±kmÄ±ÅŸ olacak. Hemen test edelim

```bash
~/cpython on main
â¯ ./python.exe
Python 3.11.0a2+ (heads/main-dirty:253b7a0a9f, Nov 26 2021, 15:26:42) [Clang 12.0.5 (clang-1205.0.22.11)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>>
```

Nice!

### Dile keyword eklemek

AslÄ±nda yapacaÄŸÄ±mÄ±z ÅŸey dile yep yeni bir keyword eklemek deÄŸil. Var olan bir keywordÃ¼n ismini deÄŸiÅŸtirmek. DolayÄ±sÄ±yla
iÅŸimiz Ã§ok daha kolay.

Python dilin syntaxÄ±nÄ± belirtmek iÃ§in `Grammar/python.gram` dosyasÄ±nÄ± kullanÄ±yor. Dil ile ilgili bir yazÄ±mÄ± deÄŸiÅŸtirmek istediÄŸimizde
bu dosyayÄ± deÄŸiÅŸtirmek gerekiyor.

DokÃ¼mantasyona bakmadan ilk aklÄ±ma gelen IDE de `elif` keywordunu bulup bunu `elseif` deÄŸiÅŸtirmekti. 354. satÄ±rÄ±n oralarÄ± ÅŸÃ¶yle deÄŸiÅŸtirdim.

```gram {8-10} title="python.gram"
if_stmt[stmt_ty]:
    | invalid_if_stmt
    | 'if' a=named_expression ':' b=block c=elif_stmt {
        _PyAST_If(a, b, CHECK(asdl_stmt_seq*, _PyPegen_singleton_seq(p, c)), EXTRA) }
    | 'if' a=named_expression ':' b=block c=[else_block] { _PyAST_If(a, b, c, EXTRA) }
elif_stmt[stmt_ty]:
    | invalid_elif_stmt
    | 'elif' a=named_expression ':' b=block c=elif_stmt {
        _PyAST_If(a, b, CHECK(asdl_stmt_seq*, _PyPegen_singleton_seq(p, c)), EXTRA) }
    | 'elif' a=named_expression ':' b=block c=[else_block] { _PyAST_If(a, b, c, EXTRA) }
else_block[asdl_stmt_seq*]:
    | invalid_else_stmt
    | 'else' &&':' b=block { b }

```

---

```text {8-10}
if_stmt[stmt_ty]:
    | invalid_if_stmt
    | 'if' a=named_expression ':' b=block c=elif_stmt {
        _PyAST_If(a, b, CHECK(asdl_stmt_seq*, _PyPegen_singleton_seq(p, c)), EXTRA) }
    | 'if' a=named_expression ':' b=block c=[else_block] { _PyAST_If(a, b, c, EXTRA) }
elif_stmt[stmt_ty]:
    | invalid_elif_stmt
    | 'elseif' a=named_expression ':' b=block c=elif_stmt {
        _PyAST_If(a, b, CHECK(asdl_stmt_seq*, _PyPegen_singleton_seq(p, c)), EXTRA) }
    | 'elseif' a=named_expression ':' b=block c=[else_block] { _PyAST_If(a, b, c, EXTRA) }
else_block[asdl_stmt_seq*]:
    | invalid_else_stmt
    | 'else' &&':' b=block { b }

#  1220 li satÄ±rlara doÄŸru ise
invalid_elif_stmt:
    | 'elseif' named_expression NEWLINE { RAISE_SYNTAX_ERROR("expected ':'") }
    | a='elseif' named_expression ':' NEWLINE !INDENT {
        RAISE_INDENTATION_ERROR("expected an indented block after 'elif' statement on line %d", a->lineno) }

```

Bu dosyayÄ± her deÄŸiÅŸtiriÄŸimzde `make regen-pegen` komutu ile `parser.c` dosyasÄ±nÄ±n bu grammar file ile
yeniden generate edilmesini saÄŸlamalÄ±yÄ±z.

```bash
~/cpython on main
â¯ make regen-pegen
PYTHONPATH=./Tools/peg_generator python3.9 -m pegen -q c \
		./Grammar/python.gram \
		./Grammar/Tokens \
		-o ./Parser/parser.new.c
python3.9 ./Tools/scripts/update_file.py ./Parser/parser.c ./Parser/parser.new.c

```

GÃ¼zel ÅŸimdi tekrar build alalÄ±m.

```bash
make -s -j8
```

Ve o da ne

```bash
~/cpython on main â‡¡1 !2
â¯ make -j8 -s
ld: warning: directory not found for option '-L/usr/local/opt/zlib/lib'
  File "<frozen importlib._bootstrap_external>", line 108
    elif new_root.endswith(':'):
    ^^^^
SyntaxError: invalid syntax
make: *** [Python/frozen_modules/importlib._bootstrap_external.h] Error 1
make: *** Waiting for unfinished jobs....
  File "<frozen importlib._bootstrap>", line 299
    elif hasattr(loader, 'module_repr'):
    ^^^^
SyntaxError: invalid syntax
make: *** [Python/frozen_modules/importlib._bootstrap.h] Error 1
  File "<frozen ntpath>", line 99
    elif p_drive and p_drive != result_drive:
    ^^^^
SyntaxError: invalid syntax
  File "<frozen _collections_abc>", line 435
    elif not _is_param_expr(t_args):
    ^^^^
SyntaxError: invalid syntax
make: *** [Python/frozen_modules/ntpath.h] Error 1
  File "<frozen posixpath>", line 85
    elif not path or path.endswith(sep):
    ^^^^
SyntaxError: invalid syntax
make: *** [Python/frozen_modules/_collections_abc.h] Error 1
make: *** [Python/frozen_modules/posixpath.h] Error 1
  File "<frozen genericpath>", line 149
    elif isinstance(s, bytes):
    ^^^^
SyntaxError: invalid syntax
make: *** [Python/frozen_modules/genericpath.h] Error 1

```

200 IQ hareket . `elif` i deÄŸiÅŸtik ama Python internal modullerinde hala `elif` kullanÄ±yor. DolayÄ±sÄ±yla parser hata Ã§Ä±kartÄ±yor.

Bunun Ã§Ã¶zmek iÃ§in `elif` keywordunu tamamen deÄŸiÅŸmek yerine `elseif` i de kullanÄ±labilir yapmak gerekiyor. DokÃ¼mantasyonda biraz gezindikten sonra
`|` operatoru ile bunu yapabileceÄŸimi anlÄ±yorum. AynÄ± yerlerdeki `'elseif'` stringlerini `('elif' | 'elseif')` bununla deÄŸiÅŸtiriyorum. `make regen-pegen`
ve `make -s -j8` komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zada.

```bash
~/cpython on main â‡¡1 !2
â¯ ./python.exe
Python 3.11.0a2+ (heads/main-dirty:36e1a69ba8, Nov 26 2021, 19:37:05) [Clang 12.0.5 (clang-1205.0.22.11)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> if True:
...     pass
... elseif False:
...     pass
...
>>>
```

Bingo!!

ArtÄ±k rahatlÄ±kla Python kullanabilirsiniz.

### Kaynaklar

- https://devguide.python.org/grammar/
- https://realpython.com/cpython-source-code-guide/
- https://isidentical-archive.github.io/cpython-yeni-operator.html
